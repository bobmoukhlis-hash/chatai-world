<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatAI World</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#ddd;
      --userbg:#e9eefc;
      --userbd:#d6defa;
      --botbg:#eefaf4;
      --botbd:#d3f3e2;
      --bottext:#0a7;
      --errbg:#ffecec;
      --errbd:#ffcccc;
      --errtext:#b00020;
      --prebg:#111;
      --pretext:#0f0;
    }

    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e8e8e8;
      --muted:#aaa;
      --border:#2a2f3a;
      --userbg:#232a44;
      --userbd:#2d3760;
      --botbg:#1e3a2b;
      --botbd:#2b5a3f;
      --bottext:#7dffb5;
      --errbg:#3a1f24;
      --errbd:#5a2a31;
      --errtext:#ffb4c0;
      --prebg:#0b0d12;
      --pretext:#8cffc6;
    }

    body{
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .title h1{
      margin:0;
      font-size:28px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--card);
      color:var(--text);
      font-size:14px;
      user-select:none;
    }

    .btn{
      padding:10px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--card);
      color:var(--text);
      cursor:pointer;
      font-size:14px;
    }

    #chat{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      height: 62vh;
      overflow-y:auto;
    }

    .msg{ margin:10px 0; display:flex; }
    .bubble{
      padding:10px 12px;
      border-radius:12px;
      max-width:85%;
      word-wrap:break-word;
      border:1px solid var(--border);
    }
    .user{ justify-content:flex-end; }
    .user .bubble{ background:var(--userbg); border-color:var(--userbd); color:var(--text); }
    .bot{ justify-content:flex-start; }
    .bot .bubble{ background:var(--botbg); border-color:var(--botbd); color:var(--bottext); }
    .error .bubble{ background:var(--errbg); border-color:var(--errbd); color:var(--errtext); }

    #inputRow{
      display:flex;
      gap:10px;
      margin-top:12px;
    }

    textarea{
      flex:1;
      resize:none;
      padding:12px;
      font-size:16px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      height:56px;
    }

    button#sendBtn{
      width:120px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--card);
      color:var(--text);
      cursor:pointer;
      font-size:16px;
    }

    #toolsRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
    }

    input[type="file"]{
      flex:1;
      padding:10px;
      border:1px dashed var(--border);
      border-radius:10px;
      background:var(--card);
      color:var(--text);
    }

    .hint{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }

    pre{
      background:var(--prebg);
      color:var(--pretext);
      padding:10px;
      border-radius:8px;
      overflow-x:auto;
    }
    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }
  </style>
</head>

<body>
  <header>
    <div class="title">
      <h1>ðŸ¤– ChatAI World</h1>
    </div>

    <div class="actions">
      <label class="pill">
        <input id="darkToggle" type="checkbox" />
        Dark
      </label>
      <button class="btn" id="newChatBtn">ðŸ†• Nuova chat</button>
    </div>
  </header>

  <div id="chat"></div>

  <div id="inputRow">
    <textarea id="t" placeholder="Scrivi un messaggio..."></textarea>
    <button id="sendBtn">Invia</button>
  </div>

  <div id="toolsRow">
    <input type="file" id="img" accept="image/*" />
  </div>

  <div class="hint">
    Enter = invia â€¢ Shift+Enter = a capo â€¢ Testo = WebSocket streaming â€¢ Foto = Vision via upload
  </div>

  <script>
    const HTTP_API = "https://chatai-world.onrender.com/chat";
    const IMAGE_API = "https://chatai-world.onrender.com/chat-image";
    const RESET_API = "https://chatai-world.onrender.com/reset";
    const WS_API = "wss://chatai-world.onrender.com/ws";

    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("t");
    const sendBtn = document.getElementById("sendBtn");
    const newChatBtn = document.getElementById("newChatBtn");
    const darkToggle = document.getElementById("darkToggle");
    const imgEl = document.getElementById("img");

    // ===== Theme =====
    const savedTheme = localStorage.getItem("theme") || "light";
    if (savedTheme === "dark") document.body.classList.add("dark");
    darkToggle.checked = document.body.classList.contains("dark");

    darkToggle.addEventListener("change", () => {
      document.body.classList.toggle("dark", darkToggle.checked);
      localStorage.setItem("theme", darkToggle.checked ? "dark" : "light");
    });

    // ===== Session =====
    function getSessionId(){
      let sid = localStorage.getItem("session_id");
      if (!sid) {
        sid = crypto.randomUUID();
        localStorage.setItem("session_id", sid);
      }
      return sid;
    }

    function setNewSessionId(){
      const sid = crypto.randomUUID();
      localStorage.setItem("session_id", sid);
      return sid;
    }

    // ===== UI helpers =====
    function addMessage(content, who, isHtml=false){
      const row = document.createElement("div");
      row.className = "msg " + who;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if (isHtml) bubble.innerHTML = content;
      else bubble.textContent = content;

      row.appendChild(bubble);
      chatEl.appendChild(row);
      row.scrollIntoView({behavior:"smooth"});
      return bubble;
    }

    function clearChat(){
      chatEl.innerHTML = "";
    }

    // ===== WebSocket streaming (testo) =====
    function wsStream(sessionId, message, botBubble){
      return new Promise((resolve, reject) => {
        const ws = new WebSocket(WS_API);
        let full = "";

        ws.onopen = () => {
          ws.send(JSON.stringify({ session_id: sessionId, message }));
        };

        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);

            if (msg.type === "token") {
              full += msg.token;
              botBubble.textContent = full;
            } else if (msg.type === "done") {
              ws.close();
              resolve(full);
            } else if (msg.type === "error") {
              ws.close();
              reject(new Error(msg.message || "Errore WS"));
            }
          } catch (e) {}
        };

        ws.onerror = () => reject(new Error("WebSocket error"));
      });
    }

    // ===== HTTP fallback (testo) =====
    async function httpChat(sessionId, message){
      const res = await fetch(HTTP_API, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ session_id: sessionId, message })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error((data.reply || `HTTP ${res.status}`).trim());
      }
      return data;
    }

    // ===== Vision upload (foto) =====
    async function imageChat(sessionId, message, file){
      const form = new FormData();
      form.append("session_id", sessionId);
      form.append("message", message || "");
      form.append("image", file);

      const res = await fetch(IMAGE_API, {
        method: "POST",
        body: form
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error((data.reply || `HTTP ${res.status}`).trim());
      }
      return data;
    }

    // ===== Send =====
    async function send(){
      const text = inputEl.value.trim();
      const file = imgEl.files && imgEl.files[0] ? imgEl.files[0] : null;
      if (!text && !file) return;

      const sessionId = getSessionId();

      if (text) addMessage(text, "user", false);
      if (file) addMessage("ðŸ“· Foto inviata", "user", false);

      inputEl.value = "";
      const botBubble = addMessage("â³ Sto pensando...", "bot", false);

      try {
        // Se c'Ã¨ una foto -> Vision via HTTP upload
        if (file) {
          const data = await imageChat(sessionId, text, file);
          botBubble.innerHTML = marked.parse(data.reply);
          imgEl.value = "";
          return;
        }

        // Solo testo -> WS streaming
        const full = await wsStream(sessionId, text, botBubble);
        botBubble.innerHTML = marked.parse(full);

      } catch (e) {
        // fallback testo via HTTP se WS fallisce
        try {
          if (!file) {
            const data = await httpChat(sessionId, text);
            botBubble.innerHTML = marked.parse(data.reply);
          } else {
            throw e;
          }
        } catch (err) {
          botBubble.textContent = "âŒ Errore: " + err.message;
          botBubble.parentElement.classList.add("error");
        }
      }
    }

    sendBtn.addEventListener("click", send);

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // ===== New chat =====
    newChatBtn.addEventListener("click", async () => {
      const oldSid = getSessionId();

      // reset backend memory best-effort
      try {
        await fetch(RESET_API, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ session_id: oldSid })
        });
      } catch (e) {}

      setNewSessionId();
      clearChat();
      addMessage(marked.parse("Nuova chat avviata âœ…\n\nCarica una foto o scrivi un messaggio."), "bot", true);

      imgEl.value = "";
      inputEl.value = "";
    });

    // Welcome
    addMessage(marked.parse("Ciao! Come posso aiutarti oggi?"), "bot", true);
  </script>
</body>
</html>
