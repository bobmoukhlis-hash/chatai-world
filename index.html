<!-- index.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ğŸŒ ChatAI World</title>
  <style>
    body{margin:0;font-family:Poppins,system-ui,Arial;background:linear-gradient(to bottom,#001018,#002a38);color:#e0faff;display:flex;flex-direction:column;height:100vh}
    header{background:linear-gradient(90deg,#00bcd4,#38bdf8);color:#001018;text-align:center;padding:14px 10px;font-weight:800;font-size:20px}
    #chat{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;box-sizing:border-box;gap:10px}
    .message{padding:10px 12px;border-radius:12px;max-width:86%;word-wrap:break-word;white-space:pre-wrap;line-height:1.35}
    .user{background:#38bdf8;color:#001018;align-self:flex-end}
    .bot{background:#002a38;align-self:flex-start;border:1px solid rgba(56,189,248,.35)}
    #input-area{display:flex;flex-direction:column;gap:10px;padding:10px;background:#001520;border-top:1px solid #38bdf8}
    #row1{display:flex;gap:8px;align-items:center}
    #row2{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #row3{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"]{flex:1;padding:12px;background:#002a38;color:#e0faff;border:none;border-radius:8px;outline:none;font-size:16px}
    button{border:none;color:#001018;font-weight:800;padding:12px 14px;border-radius:8px;cursor:pointer;transition:.2s;font-size:14px}
    button:active{transform:scale(.98)}
    .primary{background:#38bdf8}
    .ghost{background:transparent;border:1px solid rgba(56,189,248,.6);color:#e0faff}
    .toggle-on{box-shadow:0 0 0 2px rgba(79,209,197,.35) inset}
    #preview{display:none;gap:10px;align-items:center;flex-wrap:wrap}
    #preview img{max-height:64px;border-radius:10px;border:1px solid rgba(56,189,248,.35)}
    #hint{opacity:.85;font-size:12px}
    footer{padding:12px;text-align:center;background:#001520;border-top:1px solid #38bdf8}
    footer a{color:#38bdf8;text-decoration:none;font-weight:800}
  </style>
</head>
<body>
<div id="chat">
  <div class="message bot">ğŸ¤– Benvenuto su ChatAI World! Scrivi qualcosa per iniziare.</div>
</div>

<div id="input-area">
  <div id="row1">
    <input id="userInput" type="text" placeholder="Scrivi qualcosa..." autocomplete="off" />
    <button class="primary" id="sendBtn">Invia</button>
  </div>

  <div id="row2">
    <button class="ghost" id="micBtn" title="Microfono on/off">ğŸ™ï¸ Mic: OFF</button>
    <button class="ghost" id="ttsBtn" title="Voce on/off">ğŸ”Š Voce: OFF</button>
    <button class="ghost" id="resetBtn" title="Reset conversazione">ğŸ§¹ Nuova chat</button>

    <label class="ghost" style="padding:10px 12px;border-radius:8px;cursor:pointer;">
      ğŸ“· Foto
      <input id="imageInput" type="file" accept="image/*" style="display:none;" />
    </label>
  </div>

  <!-- âœ… QUI Ã¨ il posto GIUSTO per row3 -->
  <div id="row3">
    <button class="ghost mode-btn toggle-on" data-mode="general">ğŸŒ Generale</button>
    <button class="ghost mode-btn" data-mode="study">ğŸ“ Studio</button>
    <button class="ghost mode-btn" data-mode="code">ğŸ’» Coding</button>
    <button class="ghost mode-btn" data-mode="content">ğŸ¬ Social</button>
    <button class="ghost mode-btn" data-mode="translate">ğŸŒ Traduci</button>
  </div>

  <div id="preview">
    <img id="previewImg" alt="preview" />
    <button class="ghost" id="removeImgBtn">Rimuovi foto</button>
    <div id="hint">La foto verrÃ  inviata al server.</div>
  </div>
</div>

<footer>
  <a href="https://bobmoukhlis-hash.github.io">â¬…ï¸ Torna a BOUABID.DEV</a>
</footer>

<script>
  const API_URL = "https://chatai-world.onrender.com";

  const chat = document.getElementById("chat");
  const input = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const micBtn = document.getElementById("micBtn");
  const ttsBtn = document.getElementById("ttsBtn");
  const resetBtn = document.getElementById("resetBtn");
  const imageInput = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  const previewImg = document.getElementById("previewImg");
  const removeImgBtn = document.getElementById("removeImgBtn");

  // ===== Mode (row3) =====
  window.__CHAT_MODE__ = localStorage.getItem("chatai_mode") || "general";

  function highlightMode(mode) {
    document.querySelectorAll(".mode-btn").forEach(btn => {
      btn.classList.toggle("toggle-on", btn.dataset.mode === mode);
    });
  }

  function setMode(mode) {
    window.__CHAT_MODE__ = mode;
    localStorage.setItem("chatai_mode", mode);
    highlightMode(mode);
  }

  document.querySelectorAll(".mode-btn").forEach(btn => {
    btn.addEventListener("click", () => setMode(btn.dataset.mode));
  });
  highlightMode(window.__CHAT_MODE__);

  // ===== Session =====
  const SESSION_KEY = "chatai_world_session_id";
  function getSessionId() {
    let id = localStorage.getItem(SESSION_KEY);
    if (!id) {
      id = (crypto?.randomUUID?.() || (Date.now() + "-" + Math.random().toString(16).slice(2)));
      localStorage.setItem(SESSION_KEY, id);
    }
    return id;
  }

  // ===== TTS =====
  let voiceEnabled = false;
  function speak(text) {
    if (!voiceEnabled) return;
    if (!("speechSynthesis" in window)) return;
    try {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = navigator.language || "en-US"; // âœ… u.lang (non r.lang)
      window.speechSynthesis.speak(u);
    } catch (_) {}
  }

  // ===== Mic (Speech-to-text) =====
  let recognizing = false;
  let recognition = null;

  function initSpeechRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = navigator.language || "en-US"; // âœ… lingua telefono
    r.continuous = false;
    r.interimResults = false;

    r.onstart = () => {
      recognizing = true;
      micBtn.classList.add("toggle-on");
      micBtn.textContent = "ğŸ™ï¸ Mic: ON";
    };

    r.onend = () => {
      recognizing = false;
      micBtn.classList.remove("toggle-on");
      micBtn.textContent = "ğŸ™ï¸ Mic: OFF";
    };

    r.onerror = () => {
      recognizing = false;
      micBtn.classList.remove("toggle-on");
      micBtn.textContent = "ğŸ™ï¸ Mic: OFF";
    };

    r.onresult = (e) => {
      const text = e.results?.[0]?.[0]?.transcript || "";
      if (text) input.value = (input.value ? (input.value + " ") : "") + text;
    };

    return r;
  }

  recognition = initSpeechRecognition();

  // ===== Image upload =====
  let imageDataUrl = null;

  function showPreview(dataUrl) {
    preview.style.display = "flex";
    previewImg.src = dataUrl;
  }

  function hidePreview() {
    preview.style.display = "none";
    previewImg.src = "";
  }

  imageInput.addEventListener("change", () => {
    const file = imageInput.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      imageDataUrl = String(reader.result || "");
      showPreview(imageDataUrl);
    };
    reader.readAsDataURL(file);
  });

  removeImgBtn.addEventListener("click", () => {
    imageDataUrl = null;
    imageInput.value = "";
    hidePreview();
  });

  // ===== UI helpers =====
  function addMessage(text, sender) {
    const div = document.createElement("div");
    div.classList.add("message", sender);
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text && !imageDataUrl) return;

 addMessage(text || "ğŸ“· Foto inviata (descrivimi cosa vedi)", "user");
    input.value = "";

    const thinking = addMessage("ğŸ’­ Sto pensando...", "bot");

    const payload = {
      session_id: getSessionId(),
      message: text || "",
      image_data: imageDataUrl,
      preferred_lang: navigator.language || "en-US",
      mode: window.__CHAT_MODE__
    };

    try {
      const res = await fetch(`${API_URL}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({}));
      const reply = data.reply || "âš ï¸ Nessuna risposta dal server.";
      thinking.textContent = reply;
      speak(reply);
    } catch (e) {
      thinking.textContent = "âŒ Errore di connessione al server.";
    }
  }

  async function resetChat() {
    chat.innerHTML = "";
    addMessage("ğŸ¤– Benvenuto su ChatAI World! Scrivi qualcosa per iniziare.", "bot");
    input.value = "";
    imageDataUrl = null;
    imageInput.value = "";
    hidePreview();

    try {
      await fetch(`${API_URL}/reset`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: getSessionId() }),
      });
    } catch (_) {}
  }

  // ===== Wire events =====
  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });

  micBtn.addEventListener("click", () => {
    if (!recognition) return addMessage("âŒ Microfono non supportato su questo browser.", "bot");
    if (recognizing) recognition.stop();
    else recognition.start();
  });

  ttsBtn.addEventListener("click", () => {
    voiceEnabled = !voiceEnabled;
    ttsBtn.classList.toggle("toggle-on", voiceEnabled);
    ttsBtn.textContent = voiceEnabled ? "ğŸ”Š Voce: ON" : "ğŸ”Š Voce: OFF";
    if (!voiceEnabled) { try { window.speechSynthesis.cancel(); } catch (_) {} }
  });

  resetBtn.addEventListener("click", resetChat);
</script>
</body>
</html>
