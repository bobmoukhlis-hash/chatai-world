<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatAI World</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#111;
      --border:#ddd;
      --userbg:#e9eefc;
      --botbg:#eefaf4;
      --bottext:#0a7;
      --errbg:#ffecec;
      --errtext:#b00020;
    }

    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e8e8e8;
      --border:#2a2f3a;
      --userbg:#232a44;
      --botbg:#1e3a2b;
      --bottext:#7dffb5;
      --errbg:#3a1f24;
      --errtext:#ffb4c0;
    }

    body{
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 900px;
      margin: auto;
      padding: 16px;
    }

    header{
      display:flex;
      justify-content:space-between;
      margin-bottom:12px;
    }

    #chat{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      height:60vh;
      overflow-y:auto;
    }

    .msg{ margin:10px 0; display:flex; }
    .bubble{
      padding:10px 12px;
      border-radius:12px;
      max-width:80%;
    }

    .user{ justify-content:flex-end; }
    .user .bubble{ background:var(--userbg); }

    .bot{ justify-content:flex-start; }
    .bot .bubble{ background:var(--botbg); color:var(--bottext); }

    .error .bubble{
      background:var(--errbg);
      color:var(--errtext);
    }

    #inputRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }

    textarea{
      flex:1;
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      resize:none;
    }

    button{
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card);
      cursor:pointer;
    }
  </style>
</head>

<body>

<header>
  <h2>ðŸ¤– ChatAI World</h2>
  <div>
    <label>
      <input type="checkbox" id="darkToggle"> Dark
    </label>
    <button id="newChatBtn">ðŸ†• Nuova chat</button>
  </div>
</header>

<div id="chat"></div>

<div id="inputRow">
  <textarea id="t" placeholder="Scrivi un messaggio..."></textarea>
  <button id="sendBtn">Invia</button>
</div>

<input type="file" id="img" accept="image/*">

<script>
const HTTP_API  = "https://chatai-world.onrender.com/chat";
const IMAGE_API = "https://chatai-world.onrender.com/chat-image";
const RESET_API = "https://chatai-world.onrender.com/reset";

const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("t");
const imgEl   = document.getElementById("img");

/* ===== Session ===== */
function getSessionId(){
  let sid = localStorage.getItem("session_id");
  if (!sid){
    sid = crypto.randomUUID();
    localStorage.setItem("session_id", sid);
  }
  return sid;
}
function newSession(){
  localStorage.setItem("session_id", crypto.randomUUID());
}

/* ===== UI ===== */
function addMessage(text, who, html=false){
  const row = document.createElement("div");
  row.className = "msg " + who;
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  html ? bubble.innerHTML = text : bubble.textContent = text;
  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
  return bubble;
}
function clearChat(){ chatEl.innerHTML = ""; }

/* ===== SEND ===== */
async function send(){
  const text = inputEl.value.trim();
  const file = imgEl.files[0];
  if (!text && !file) return;

  const sessionId = getSessionId();

  if (text) addMessage(text,"user");
  if (file) addMessage("ðŸ“· Foto inviata","user");

  inputEl.value = "";
  const bot = addMessage("â³ Attendo risposta...","bot");

  try{
    let res;

    if (file){
      const form = new FormData();
      form.append("session_id", sessionId);
      form.append("message", text || "");
      form.append("image", file);
      res = await fetch(IMAGE_API,{ method:"POST", body:form });
    } else {
      res = await fetch(HTTP_API,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ session_id:sessionId, message:text })
      });
    }

    const raw = await res.text();
    let data;
    try{
      data = JSON.parse(raw);
    }catch{
      throw new Error("Risposta non JSON dal server");
    }

    if (!res.ok){
      throw new Error(data.reply || "Errore server");
    }

    bot.innerHTML = marked.parse(data.reply);
    imgEl.value = "";

  }catch(err){
    bot.textContent = "âŒ " + err.message;
    bot.parentElement.classList.add("error");
  }
}

/* ===== Events ===== */
document.getElementById("sendBtn").onclick = send;
inputEl.addEventListener("keydown",e=>{
  if (e.key==="Enter" && !e.shiftKey){
    e.preventDefault(); send();
  }
});

document.getElementById("newChatBtn").onclick = async ()=>{
  try{
    await fetch(RESET_API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ session_id:getSessionId() })
    });
  }catch{}
  newSession();
  clearChat();
  addMessage("Nuova chat avviata âœ…","bot");
};

document.getElementById("darkToggle").onchange = e=>{
  document.body.classList.toggle("dark",e.target.checked);
};

/* ===== Welcome ===== */
addMessage("Ciao! Come posso aiutarti oggi?","bot");
</script>

</body>
</html>
